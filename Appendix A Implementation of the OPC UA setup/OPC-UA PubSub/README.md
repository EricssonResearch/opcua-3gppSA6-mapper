
# Intorudction

This library contains the modified code and executables used to create unique flow topics with Open Platform Communication United Architecture PubSub.
Used open62541 an open source implementation of OPC UA. 
The development build was used first (with commit hash (695864553127fb2f67dbbec848e38bd40f7e4d59)). This was chose, because when first working with OPC UA PubSub it was this version, that had included examples for the publisher and subscriber as well.
The original examples were modified to publish/subscribe to multiple topics with specified names and different QoS settings to the appropriate MQTT broker.
The publisher publishes to the proxy broker, which sends the topics through different topic bridges. 

The publisher has another modified version that also makes use of UNIX sockets to publish it's internal API for changing the publishing interval. This API was created based on the Common API Framework (CAPIF) by EVOLVED-5G as proof of concept for the standardization of API sharing, which was later moved under OpenCAPIF. The original repo was archived and the OpenCAPIF maintained by ETSI Labs is the one to be used. The publisher communicates with a JavaScript code, that registers to the the CAPIF Core Services and after proper authentication publishes it's API. The published API is discovered by another JavaScript code, that can invoke it on the subscriber's needs. 

For the final version the 1.4 version was used! 
For the 1.4 branch, there are some instructions requirements in the folder 1 level up and necessary packages to be installed.
The requirements.txt contains the necessary packages, while for fixing the 1.4 branch you can use the [below](#installation-of-open62541) instructions.
This allows for successful modified executable creation of open62541 examples.

Everything was written and tested on Ubuntu 22.04 LTS.

# Installation of open62541

For the user to further modify the code, the following steps are necessary to set up the development environment:
```
#update and install the necessary packages
sudo apt update
xargs -a requirements.txt sudo apt install -y
```
Switch to branch 1.4 for in open62541 and use:
```
#in open62541 folder
git checkout 1.4

#in the same directory as the requirements.txt / this README.md
#I advise manual checking, because this shell script was generated by ChatGPT in the last minute for ease of use and was untested
chmod +x Fix_open62541_1.4.sh
./Fix_open62541_1.4.sh
```

Which is: Manually add the "#include <stdlib.h>" if missing to the following files:
- ~/open62541/build/src_generated/open62541/config.h
- ~/open62541/examples/pubsub/tutorial_pubsub_mqtt_publish.c
- ~/open62541/examples/pubsub/tutorial_pubsub_mqtt_subscribe.c
- ~/open62541/examples/json_config/server_file_based_config.c
And replace the mqtt publish.c subcribe.c examples in the open62541/examples/pubsub/ directory.
Don't forget to add the capif versions to the CMakeLists in the examples folder!

And change PTHREAD_MUTEX_RECURSIVE to PTHREAD_MUTEX_RECURSIVE_NP in "~/open62541/examples/pubsub_realtime/server_pubsub_publisher_rt_level.c". 
The actual line starts like: "pthread_mutexattr_settype(&mattr, PTHREAD_MUTEX_RECURSIVE);", but you need "pthread_mutexattr_settype(&mattr, PTHREAD_MUTEX_RECURSIVE_NP);".

As for building the whole open62541 project:
```
cd ~/open62541
mkdir build
cd build
ccmake ..
make
```
For ccmake set the following settings accordingly:
```
ENABLE_ASAN=ON
ENABLE_BUILD_INTO_OPEN62541=ON
ENABLE_EXAMPLES=ON
UA_ENABLE_ASAN=ON
UA_BUILD_EXAMPLES=ON
UA_BUILD_TOOLS=ON
UA_ENABLE_DA=ON
UA_ENABLE_DEBUG_SANITIZER=ON
UA_ENABLE_DIAGNOSTICS=ON
UA_ENABLE_DISCOVERY=ON
UA_ENABLE_JSON_ENCODING=ON
UA_ENABLE_MALLOC_SINGLETON=ON
UA_ENABLE_METHODCALLS=ON
UA_ENABLE_MQTT=ON
UA_ENABLE_NODESETLOADER=OFF
UA_ENABLE_PUBSUB=ON
UA_ENABLE_PUBSUB_INFORMATIONMODEL=ON
UA_ENABLE_SUBSCRIPTIONS=ON
UA_ENABLE_SUBSCRIPTIONS_EVENTS=ON
UA_ENABLE_XML_ENCODING=OFF
```


# Usage

There are the executables, that can be ran with "./name_of_the_executable", and the source code, that can be used to build executables in the open62541 repository.
These are MQTT publisher and subscriber, which needs broker. First run the broker, before running the executables.
The library contains the subdirectories of publisher and subscriber. Each contains the source code and executable necessary for testing on the network, Mininet or locally.
The local_test subdirectory contains the codes that are used for testing with one machine.

For running the publisher:
```
./tutorial_pubsub_mqtt_publish
```

For starting the subscriber:
```
./tutorial_pubsub_mqtt_subscribe
```


Running with custom IPs and ports:
```
./tutorial_pubsub_mqtt_publish --url opc.mqtt://127.0.0.1:1883 --topic topic1 topic2 --freq 600 500
./tutorial_pubsub_mqtt_subscribe --url opc.mqtt://10.1.2.2:8083 --topic topic1 topic2 --freq 600 500
```

Usage:
```
"Usage: tutorial_pubsub_mqtt_publish [--url <opc.mqtt://hostname:port>] "
        "[--topic <1 or 2 mqttTopics, with space in between>] "
        "[--freq <1 or 2 frequencies in ms, with space in between>]"
        "[--json]\n"
        "  Defaults are:\n"
        "  - Url: opc.mqtt://127.0.0.1:1883\n"
        "  - Topic: topic1 topic2\n"
        "  - Frequency: 600 500\n"
        "  - JSON: Off\n"
```

```
"Usage: tutorial_pubsub_mqtt_subscribe [--url <opc.mqtt://hostname:port>] "
        "[--topic <1 or 2 mqttTopics, with space in between>] "
        "[--freq <1 or 2 frequencies in ms, with space in between>]"
        "[--json]\n"
        "  Defaults are:\n"
        "  - Url: opc.mqtt://127.0.0.1:1883\n"
        "  - Topic: topic1 topic2\n"
        "  - Frequency: 600 500\n"
        "  - JSON: Off\n"
```